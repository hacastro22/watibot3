Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[Tool] Round 1 - Requested: get_price_for_date with call_id: call_vAOcwdPtywc2fFE7K3tr9n0t args={"date_str":"2026-01-01"}
Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.database_client:Executing query: SELECT lh_adulto, lh_nino, pa_adulto, pa_nino, es_adulto, es_nino
Nov 21 15:34:22 membership start_watibot4.sh[985938]:             FROM tarifarios
Nov 21 15:34:22 membership start_watibot4.sh[985938]:             WHERE STR_TO_DATE(date, '%m/%d/%Y') = %s with params: ('2026-01-01',)
Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.database_client:Raw query result for 2026-01-01: {'lh_adulto': '79.00', 'lh_nino': '39.50', 'pa_adulto': '29.00', 'pa_nino': '14.50', 'es_adulto': '74.00', 'es_nino': '37.00'}
Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.database_client:Prices for 2026-01-01: {'lh_adulto': '79.00', 'lh_nino': '39.50', 'pa_adulto': '29.00', 'pa_nino': '14.50', 'es_adulto': '74.00', 'es_nino': '37.00'}
Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[Tool] Round 1 - Requested: load_additional_modules with call_id: call_s1L35myNVCkJzJ2xsKlP6gF9 args={"modules":["MODULE_2B_PRICE_INQUIRY"],"reasoning":"Need bank account details from payment_methods.bank_deposit_info to provide correct deposit information."}
Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_2B_PRICE_INQUIRY
Nov 21 15:34:22 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Saved 1 loaded modules at message 22
Nov 21 15:34:32 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:34:32 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 15:34:32 membership start_watibot4.sh[985938]: INFO:app.openai_agent:Final response from OpenAI: ¬°Perfecto, much√≠simas gracias por confirmarlo üå¥!
Nov 21 15:34:32 membership start_watibot4.sh[985938]: Revalidamos para sus fechas (**31 de diciembre al ...
Nov 21 15:34:32 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] OpenAI response for 50375638838: '¬°Perfecto, much√≠simas gracias por confirmarlo üå¥!\n\nRevalidamos para sus fechas (**31 de diciembre al 2 de enero**, 2 noches, **Bungalow Junior**, **2 adultos y 1 ni√±o** con **Paquete Las Hojas**) y se mantiene:\n\n- **Total por las 2 noches:** **$470.00**  \n- **50% a depositar ahora:** **$235.00**  \n- **50% a pagar al llegar:** **$235.00**\n\nAqu√≠ le comparto los **datos oficiales de la cuenta bancaria del hotel** para que realice el dep√≥sito del **50% ($235.00)**:\n\nüè¶ **Banco:** Banco de Am√©rica Central  \nüßæ **Tipo de cuenta:** Cuenta Corriente  \n#Ô∏è‚É£ **N√∫mero de cuenta:** **200252070**  \nüë§ **Titular:** Inversiones Inmobiliarias Italia S.A. de C.V.  \nüìå **Persona:** Jur√≠dica  \n\nPor favor, cuando haga el dep√≥sito:\n\n1. Realice el dep√≥sito/transferencia por **$235.00** a esa cuenta.  \n2. Tome una **foto o captura clara del comprobante**.  \n3. Env√≠enos aqu√≠ la imagen del comprobante para poder **verificar el pago y avanzar con su reserva** (dejando registrado que el resto se pagar√° al llegar).\n\nEn cuanto nos env√≠e el comprobante, seguimos de inmediato con el siguiente paso ‚òÄÔ∏è'
Nov 21 15:34:32 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50375638838
Nov 21 15:34:34 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50375638838 "HTTP/1.1 200 OK"
Nov 21 15:34:34 membership start_watibot4.sh[985938]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBIwQUZGNDAwNTQzODI0RUQzRkIA","localMessageId":"3413b119-8596-499c-8af8-67d020d6b4ab","text":"¬°Perfecto, much√≠simas gracias por confirmarlo üå¥!\n\nRevalidamos para sus fechas (**31 de diciembre al 2 de enero**, 2 noches, **Bungalow Junior**, **2 adultos y 1 ni√±o** con **Paquete Las Hojas**) y se mantiene:\n\n- **Total por las 2 noches:** **$470.00**  \n- **50% a depositar ahora:** **$235.00**  \n- **50% a pagar al llegar:** **$235.00**\n\nAqu√≠ le comparto los **datos oficiales de la cuenta bancaria del hotel** para que realice el dep√≥sito del **50% ($235.00)**:\n\nüè¶ **Banco:** Banco de Am√©rica Central  \nüßæ **Tipo de cuenta:** Cuenta Corriente  \n#Ô∏è‚É£ **N√∫mero de cuenta:** **200252070**  \nüë§ **Titular:** Inversiones Inmobiliarias Italia S.A. de C.V.  \nüìå **Persona:** Jur√≠dica  \n\nPor favor, cuando haga el dep√≥sito:\n\n1. Realice el dep√≥sito/transferencia por **$235.00** a esa cuenta.  \n2. Tome una **foto o captura clara del comprobante**.  \n3. Env√≠enos aqu√≠ la imagen del comprobante para poder **verificar el pago y avanzar con su reserva** (dejando registrado que el resto se pagar√° al llegar).\n\nEn cuanto nos env√≠e el comprobante, seguimos de inmediato con el siguiente paso ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763739273","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"691fb9697f0c0cebc9ec8f63","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"69208689ff5d1d0570c333dc","tenantId":"1087","created":"2025-11-21T15:34:33.3037215Z","conversationId":"691fb9691d945cd24e46e954","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 15:34:34 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50375638838 after 1 attempts
Nov 21 15:34:34 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Timer cleanup complete for 50375638838, no orphaned messages
Nov 21 15:34:34 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[LOCK] Released processing lock for 50375638838 (worker PID 985938)
Nov 21 15:37:57 membership start_watibot4.sh[985943]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Quisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©', reply_context='', waId=50378193399, owner=False, operatorName=None
Nov 21 15:37:57 membership start_watibot4.sh[985943]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50378193399, message_key=50378193399:8c1d62cfaa97 (total active: 1)
Nov 21 15:37:57 membership start_watibot4.sh[985943]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:37:57 membership start_watibot4.sh[985943]: INFO:     35.240.136.56:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50378193399","userMessage":"Quisiera informaci\xc3\xb3n para una estad\xc3\xada para 5 adultos y un beb\xc3\xa9","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '3523609624486449436', 'x-datadog-parent-id': '5581889068568864640', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=9a346bbe8ab7387d', 'traceparent': '00-9a346bbe8ab7387d30e66048daa9911c-4d76da88a3aee780-00', 'tracestate': 'dd=s:0;p:4d76da88a3aee780', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '34.143.191.35', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '133', 'connection': 'Keep-Alive'}
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50378193399, type=unknown, text_preview='Quisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©'
Nov 21 15:37:57 membership start_watibot4.sh[985942]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '34.143.191.35', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:PARSED DATA: {'waId': '50378193399', 'userMessage': 'Quisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:[DEBUG] Parsed waId: 50378193399, message: 'Quisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©', replyContextId: None, caption: None
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50378193399:8c1d62cfaa97 (type=text)
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50378193399
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50378193399 (worker PID 985942)
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50378193399 at 2025-11-21 15:37:57.609075
Nov 21 15:37:57 membership start_watibot4.sh[985942]: INFO:     34.143.191.35:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:38:07 membership start_watibot4.sh[985943]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50378193399, message_key=50378193399:8c1d62cfaa97
Nov 21 15:38:07 membership start_watibot4.sh[985943]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50378193399, type=text, content=Quisiera informaci√≥n para una estad√≠a para 5 adult...
Nov 21 15:38:07 membership start_watibot4.sh[985943]: INFO:app.main:[SAFETY_NET] Started timer thread for 50378193399
Nov 21 15:38:07 membership start_watibot4.sh[985943]: INFO:app.main:[SAFETY_NET] Successfully forwarded message to processing
Nov 21 15:38:07 membership start_watibot4.sh[985943]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50378193399:8c1d62cfaa97
Nov 21 15:38:09 membership start_watibot4.sh[985941]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='El 30 de diciembre al 1 de enero', reply_context='', waId=50378193399, owner=False, operatorName=None
Nov 21 15:38:09 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50378193399, message_key=50378193399:275bd47c82b2 (total active: 1)
Nov 21 15:38:09 membership start_watibot4.sh[985941]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:38:09 membership start_watibot4.sh[985941]: INFO:     35.240.187.225:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50378193399","userMessage":"El 30 de diciembre al 1 de enero","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '11480426381483510334', 'x-datadog-parent-id': '9500631305647441294', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=32e75c957e6fb5be', 'traceparent': '00-32e75c957e6fb5be9f52aaf7d2590a3e-83d905d60312458e-00', 'tracestate': 'dd=s:0;p:83d905d60312458e', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '34.124.130.123', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '100', 'connection': 'Keep-Alive'}
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50378193399, type=unknown, text_preview='El 30 de diciembre al 1 de enero'
Nov 21 15:38:09 membership start_watibot4.sh[985938]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '34.124.130.123', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:PARSED DATA: {'waId': '50378193399', 'userMessage': 'El 30 de diciembre al 1 de enero', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:[DEBUG] Parsed waId: 50378193399, message: 'El 30 de diciembre al 1 de enero', replyContextId: None, caption: None
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50378193399:275bd47c82b2 (type=text)
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50378193399
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[LOCK] Processing lock for 50378193399 already held by worker PID 985942 (locked at 2025-11-21 15:37:57)
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:app.main:[TIMER_THREAD] Another worker is processing 50378193399, message buffered (will be included in that batch)
Nov 21 15:38:09 membership start_watibot4.sh[985938]: INFO:     34.124.130.123:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:38:19 membership start_watibot4.sh[985941]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50378193399, message_key=50378193399:275bd47c82b2
Nov 21 15:38:19 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50378193399, type=text, content=El 30 de diciembre al 1 de enero...
Nov 21 15:38:19 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET] Started timer thread for 50378193399
Nov 21 15:38:19 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET] Successfully forwarded message to processing
Nov 21 15:38:19 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50378193399:275bd47c82b2
Nov 21 15:38:21 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Perfecto gracias al tener el comprobante del posito lo envio', reply_context='wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBIwQUZGNDAwNTQzODI0RUQzRkIA', waId=50375638838, owner=False, operatorName=None
Nov 21 15:38:21 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50375638838, message_key=50375638838:7089bac99ad1 (total active: 1)
Nov 21 15:38:21 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:38:21 membership start_watibot4.sh[985940]: INFO:     136.110.25.159:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50375638838","userMessage":"Perfecto gracias al tener el comprobante del posito lo envio","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '14332436144750887851', 'x-datadog-parent-id': '10982849785232887246', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=e6332008efb79c9a', 'traceparent': '00-e6332008efb79c9ac6e70abcb5d883ab-986aebb0a6480dce-00', 'tracestate': 'dd=s:0;p:986aebb0a6480dce', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '35.240.136.56', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '128', 'connection': 'Keep-Alive'}
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50375638838, type=unknown, text_preview='Perfecto gracias al tener el comprobante del posito lo envio'
Nov 21 15:38:21 membership start_watibot4.sh[985942]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '35.240.136.56', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:PARSED DATA: {'waId': '50375638838', 'userMessage': 'Perfecto gracias al tener el comprobante del posito lo envio', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:[DEBUG] Parsed waId: 50375638838, message: 'Perfecto gracias al tener el comprobante del posito lo envio', replyContextId: None, caption: None
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50375638838:7089bac99ad1 (type=text)
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50375638838
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50375638838 (worker PID 985942)
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50375638838 at 2025-11-21 15:38:21.650269
Nov 21 15:38:21 membership start_watibot4.sh[985942]: INFO:     35.240.136.56:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:38:31 membership start_watibot4.sh[985940]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50375638838, message_key=50375638838:7089bac99ad1
Nov 21 15:38:31 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50375638838, type=text, content=Perfecto gracias al tener el comprobante del posit...
Nov 21 15:38:31 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Started timer thread for 50375638838
--
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Buen dia, muchas gracias', reply_context='', waId=50372117927, owner=False, operatorName=None
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50372117927, message_key=50372117927:31d79d5bd600 (total active: 1)
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:     34.87.23.250:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50372117927","userMessage":"Buen dia, muchas gracias","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '8260932973402056252', 'x-datadog-parent-id': '2015992508350654486', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=c7cbda254b0756fb', 'traceparent': '00-c7cbda254b0756fb72a4bac560f0e63c-1bfa3e815216e816-00', 'tracestate': 'dd=s:0;p:1bfa3e815216e816', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '136.110.63.10', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '92', 'connection': 'Keep-Alive'}
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50372117927, type=unknown, text_preview='Buen dia, muchas gracias'
Nov 21 15:38:45 membership start_watibot4.sh[985940]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '136.110.63.10', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:PARSED DATA: {'waId': '50372117927', 'userMessage': 'Buen dia, muchas gracias', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[DEBUG] Parsed waId: 50372117927, message: 'Buen dia, muchas gracias', replyContextId: None, caption: None
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50372117927:31d79d5bd600 (type=text)
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Marked message as processed: 50372117927:31d79d5bd600
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50372117927
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50372117927 (worker PID 985940)
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50372117927 at 2025-11-21 15:38:45.915184
Nov 21 15:38:45 membership start_watibot4.sh[985940]: INFO:     136.110.63.10:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:38:55 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Message already processed by main webhook: 50372117927:31d79d5bd600
Nov 21 15:38:55 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50372117927:31d79d5bd600
Nov 21 15:38:57 membership start_watibot4.sh[985943]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50378193399:8c1d62cfaa97
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Timer for 50378193399 started at 2025-11-21 15:37:57.609075, using buffer window of 70s
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50378193399 since 2025-11-21 15:37:52 (looking back 70s)
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 4 total messages for 50378193399: [('text', '2025-11-21 15:38:19'), ('text', '2025-11-21 15:38:09'), ('text', '2025-11-21 15:38:07'), ('text', '2025-11-21 15:37:57')]
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 4 messages within cutoff window for 50378193399: [('text', None), ('text', ''), ('text', None), ('text', '')]
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 4 messages from buffer for 50378193399
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Sending combined prompt for 50378193399: 'Quisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©\nQuisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©\nEl 30 de diciembre al 1 de enero\nEl 30 de diciembre al 1 de enero'
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50378193399. Agent context will be handled inline.
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.main:[MISSED_MESSAGES_CHECK] No previous webhook timestamp for 50378193399 (first message)
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Attempt 1 to get OpenAI response for 50378193399 (elapsed: 0.0s)
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Base modules loaded: 57878 chars, Initial reduction: 67.4%
Nov 21 15:39:02 membership start_watibot4.sh[985942]: WARNING:app.openai_agent:[OpenAI] Invalid thread_id format: 50378193399. Will create new conversation.
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[OpenAI] Creating new conversation for 50378193399
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/conversations "HTTP/1.1 200 OK"
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[OpenAI] Created conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 15:39:02 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[OpenAI] No previous response ID found in local storage
Nov 21 15:39:04 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[AGENT_CONTEXT] Injecting agent context for conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 15:39:04 membership start_watibot4.sh[985942]: INFO:openai._base_client:Retrying request to /responses in 0.482580 seconds
Nov 21 15:39:06 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:39:06 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context successfully injected for conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 15:39:06 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Sending base_modules at message 1 (new_conv=True, after_context=True, periodic=False, time_gap=None [N/A since last])
Nov 21 15:39:09 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50378193399:275bd47c82b2
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[OpenAI] Started new conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[Tool] Round 1 - Requested: load_additional_modules with call_id: call_6gkY2Ea5AiNRGGmsfiqXpWuU args={"modules":["MODULE_1_CRITICAL_WORKFLOWS","MODULE_2A_PACKAGE_CONTENT","MODULE_2B_PRICE_INQUIRY","MODULE_2C_AVAILABILITY","MODULE_2D_SPECIAL_SCENARIOS","MODULE_4_INFORMATION"],"reasoning":"Cliente solicita informaci√≥n/cotizaci√≥n de estad√≠a (alojamiento) para fechas espec√≠ficas dentro de temporada navide√±a/a√±o nuevo. Necesitamos pre_quote_member_check, reglas de ocupaci√≥n, contenido de paquetes, precios, disponibilidad y menci√≥n de actividades especiales de fin de a√±o."}
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_1_CRITICAL_WORKFLOWS
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_2A_PACKAGE_CONTENT
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_2B_PRICE_INQUIRY
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_2C_AVAILABILITY
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_2D_SPECIAL_SCENARIOS
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_4_INFORMATION
Nov 21 15:39:09 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Saved 6 loaded modules at message 1
Nov 21 15:39:12 membership start_watibot4.sh[985943]: INFO:app.main:[BUFFER] Timer for 50378193399 started at 2025-11-21 15:38:07.264088, using buffer window of 70s
Nov 21 15:39:12 membership start_watibot4.sh[985943]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50378193399 since 2025-11-21 15:38:02 (looking back 70s)
Nov 21 15:39:12 membership start_watibot4.sh[985943]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 total messages for 50378193399: []
Nov 21 15:39:12 membership start_watibot4.sh[985943]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 messages within cutoff window for 50378193399: []
Nov 21 15:39:12 membership start_watibot4.sh[985943]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 0 messages from buffer for 50378193399
Nov 21 15:39:12 membership start_watibot4.sh[985943]: INFO:app.main:[BUFFER] No messages to process for 50378193399
Nov 21 15:39:21 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50375638838:7089bac99ad1
Nov 21 15:39:22 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:39:23 membership start_watibot4.sh[985942]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 15:39:23 membership start_watibot4.sh[985942]: INFO:app.openai_agent:Final response from OpenAI: ¬°Muchas gracias por la informaci√≥n! üå¥
Nov 21 15:39:23 membership start_watibot4.sh[985942]: Para poder brindarle la tarifa y opciones correctas para **es...
Nov 21 15:39:23 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] OpenAI response for 50378193399: '¬°Muchas gracias por la informaci√≥n! üå¥\n\nPara poder brindarle la tarifa y opciones correctas para **estad√≠a del 30 de diciembre al 1 de enero (2 noches) para 5 adultos y 1 beb√©**, primero debo hacer un paso obligatorio:\n\nAntes de cotizar alojamiento, necesitamos confirmar algo:\n\n¬øEs usted **socio** de nuestro club o viene como **p√∫blico general**? (atendemos tanto socios como no socios) ‚òÄÔ∏è'
Nov 21 15:39:23 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50378193399
Nov 21 15:39:24 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] Timer for 50378193399 started at 2025-11-21 15:38:19.157752, using buffer window of 70s
Nov 21 15:39:24 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50378193399 since 2025-11-21 15:38:14 (looking back 70s)
Nov 21 15:39:24 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 total messages for 50378193399: []
Nov 21 15:39:24 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 messages within cutoff window for 50378193399: []
Nov 21 15:39:24 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 0 messages from buffer for 50378193399
Nov 21 15:39:24 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] No messages to process for 50378193399
Nov 21 15:39:24 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50378193399 "HTTP/1.1 200 OK"
Nov 21 15:39:24 membership start_watibot4.sh[985942]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzgxOTMzOTkVAgARGBI4N0EwODYzMzJERkJDMjIxNEMA","localMessageId":"077eb886-a96c-4033-ada2-60157797fcdc","text":"¬°Muchas gracias por la informaci√≥n! üå¥\n\nPara poder brindarle la tarifa y opciones correctas para **estad√≠a del 30 de diciembre al 1 de enero (2 noches) para 5 adultos y 1 beb√©**, primero debo hacer un paso obligatorio:\n\nAntes de cotizar alojamiento, necesitamos confirmar algo:\n\n¬øEs usted **socio** de nuestro club o viene como **p√∫blico general**? (atendemos tanto socios como no socios) ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763739563","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"692087535507f29f73e67fb4","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"692087ab0a49d58a4de03382","tenantId":"1087","created":"2025-11-21T15:39:23.2941342Z","conversationId":"692087531d945cd24e491570","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 15:39:24 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50378193399 after 1 attempts
Nov 21 15:39:24 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Timer cleanup complete for 50378193399, no orphaned messages
Nov 21 15:39:24 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[LOCK] Released processing lock for 50378193399 (worker PID 985942)
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Timer for 50375638838 started at 2025-11-21 15:38:21.650269, using buffer window of 70s
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50375638838 since 2025-11-21 15:38:16 (looking back 70s)
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 total messages for 50375638838: [('text', '2025-11-21 15:38:31'), ('text', '2025-11-21 15:38:21')]
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 messages within cutoff window for 50375638838: [('text', None), ('text', 'wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBIwQUZGNDAwNTQzODI0RUQzRkIA')]
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 2 messages from buffer for 50375638838
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.main:[REPLY_CONTEXT] Text message has reply context: wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBIwQUZGNDAwNTQzODI0RUQzRkIA
Nov 21 15:39:26 membership start_watibot4.sh[985942]: INFO:app.main:[REPLY_CONTEXT] Retrieving original message: waId=50375638838, messageId=wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBIwQUZGNDAwNTQzODI0RUQzRkIA
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: GET https://live-mt-server.wati.io/1087/api/v1/getMessages/50375638838 "HTTP/1.1 200 OK"
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:app.main:[REPLY_CONTEXT] API response status: 200
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:app.main:[REPLY_CONTEXT] Retrieved 3 messages
Nov 21 15:39:27 membership start_watibot4.sh[985942]: ERROR:app.main:[REPLY_CONTEXT] Error retrieving original message: 'str' object has no attribute 'get'
Nov 21 15:39:27 membership start_watibot4.sh[985942]: Traceback (most recent call last):
Nov 21 15:39:27 membership start_watibot4.sh[985942]:   File "/home/robin/watibot4/app/main.py", line 500, in get_original_message_context
Nov 21 15:39:27 membership start_watibot4.sh[985942]:     if msg.get("whatsappMessageId") == reply_context_id:
Nov 21 15:39:27 membership start_watibot4.sh[985942]: AttributeError: 'str' object has no attribute 'get'
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:app.main:[REPLY_CONTEXT] No context found for ID: wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBIwQUZGNDAwNTQzODI0RUQzRkIA
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Sending combined prompt for 50375638838: 'Perfecto gracias al tener el comprobante del posito lo envio\nPerfecto gracias al tener el comprobante del posito lo envio'
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50375638838. Agent context will be handled inline.
Nov 21 15:39:27 membership start_watibot4.sh[985942]: INFO:app.main:[MISSED_MESSAGES_CHECK] 50375638838: Previous webhook at 2025-11-21 15:33:10, time_diff=377.3s
Nov 21 15:39:29 membership start_watibot4.sh[985942]: INFO:app.main:[MISSED_MESSAGES_CHECK] Found 1468 chars of missed messages for 50375638838
--
Nov 21 15:39:47 membership start_watibot4.sh[985942]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50375638838 "HTTP/1.1 200 OK"
Nov 21 15:39:47 membership start_watibot4.sh[985942]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBJDMkEzOEEzNzVEOTVBNzU2NDAA","localMessageId":"aedc8a4e-ab8c-43cd-8c8b-df2b30ecdf05","text":"Perfecto, much√≠simas gracias üå¥\n\nQuedamos entonces pendientes de que realice el **dep√≥sito de $235.00** y nos env√≠e por aqu√≠ la **foto clara del comprobante** (donde se vea monto y fecha).\n\nEn cuanto lo reciba, verificamos el pago y seguimos con el siguiente paso para dejar su hospedaje del **31 de diciembre al 2 de enero** correctamente registrado. ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763739587","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"691fb9697f0c0cebc9ec8f63","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"692087c28f638a911c220835","tenantId":"1087","created":"2025-11-21T15:39:46.8328189Z","conversationId":"691fb9691d945cd24e46e954","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 15:39:47 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50375638838 after 1 attempts
Nov 21 15:39:47 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Timer cleanup complete for 50375638838, no orphaned messages
Nov 21 15:39:47 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[LOCK] Released processing lock for 50375638838 (worker PID 985942)
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer for 50372117927 started at 2025-11-21 15:38:45.915184, using buffer window of 70s
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50372117927 since 2025-11-21 15:38:40 (looking back 70s)
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 1 total messages for 50372117927: [('text', '2025-11-21 15:38:45')]
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 1 messages within cutoff window for 50372117927: [('text', None)]
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 1 messages from buffer for 50372117927
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Sending combined prompt for 50372117927: 'Buen dia, muchas gracias'
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50372117927. Agent context will be handled inline.
Nov 21 15:39:50 membership start_watibot4.sh[985940]: INFO:app.main:[MISSED_MESSAGES_CHECK] 50372117927: Previous webhook at 2025-11-20 23:22:53, time_diff=58617.9s
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.main:[MISSED_MESSAGES_CHECK] Found 1341 chars of missed messages for 50372117927
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Attempt 1 to get OpenAI response for 50372117927 (elapsed: 0.0s)
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[DYNAMIC_LOADING] Base modules loaded: 57878 chars, Initial reduction: 67.4%
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Reusing existing conversation conv_691fa30a89dc819494b978e5dc18c83207cdc381c358811e
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Found previous response resp_07cdc381c358811e00691fa3104a70819492b164b0d7daf376 to continue from
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context already injected for conversation conv_691fa30a89dc819494b978e5dc18c83207cdc381c358811e
Nov 21 15:39:52 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Sending base_modules at message 2 (new_conv=False, after_context=False, periodic=False, time_gap=True [58617.9s since last])
Nov 21 15:39:53 membership start_watibot4.sh[985942]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='No soy socio', reply_context='', waId=50378193399, owner=False, operatorName=None
Nov 21 15:39:53 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50378193399, message_key=50378193399:f2dc60a35405 (total active: 1)
Nov 21 15:39:53 membership start_watibot4.sh[985942]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [FETCH] Getting messages from WATI API...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [FETCH] Page 1...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [SUCCESS] Found 8 messages on page 1
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [FETCH] Page 2...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [INFO] No more messages found on page 2
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [STATS] Total API messages: 8
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [MISSED_MESSAGES] Cutoff timestamp (PREVIOUS assistant response) for 50375638838: 2025-11-21 15:34:32+00:00
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [FETCH] Getting messages from WATI API...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [FETCH] Page 1...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [SUCCESS] Found 95 messages on page 1
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [FETCH] Page 2...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [INFO] No more messages found on page 2
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [STATS] Total API messages: 95
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [WEBHOOK] Getting webhook-received messages from database...
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [WEBHOOK] No OpenAI thread found for waId: 50375638838
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [STATS] Webhook messages found: 0
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ================================================================================
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [COMPARISON] Finding customer messages sent to agents (not webhook)
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ================================================================================
--
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [10] 2025-11-21 15:27:56
Nov 21 15:39:53 membership start_watibot4.sh[985942]:     Text: "Gracias, en unos momentos responderemos a su pregunta"
Nov 21 15:39:53 membership start_watibot4.sh[985942]:     assignedId: 60507e60ac6a43ee20c4d602
Nov 21 15:39:53 membership start_watibot4.sh[985942]:     operatorName: 'Bot '
Nov 21 15:39:53 membership start_watibot4.sh[985942]:     eventType: message
Nov 21 15:39:53 membership start_watibot4.sh[985942]:     ‚úÖ NOT FOUND IN WEBHOOK - Likely sent to human agent
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ... and 79 more messages
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ================================================================================
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [SUMMARY] MESSAGE CLASSIFICATION
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ================================================================================
Nov 21 15:39:53 membership start_watibot4.sh[985942]: Total API messages analyzed: 95
Nov 21 15:39:53 membership start_watibot4.sh[985942]: API messages with text: 89
Nov 21 15:39:53 membership start_watibot4.sh[985942]: Webhook interactions (received + sent): 0
Nov 21 15:39:53 membership start_watibot4.sh[985942]: Customer-to-agent messages: 89
Nov 21 15:39:53 membership start_watibot4.sh[985942]: üéØ NEXT STEPS:
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ‚úÖ Implement injection of these 89 customer-to-agent messages
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ‚úÖ Add corresponding human agent responses for full context
Nov 21 15:39:53 membership start_watibot4.sh[985942]: ‚úÖ Format as system messages in OpenAI threads
Nov 21 15:39:53 membership start_watibot4.sh[985942]: [MISSED_MESSAGES] Found 3 messages in gap for 50375638838
Nov 21 15:39:53 membership start_watibot4.sh[985942]: INFO:     136.110.25.159:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50378193399","userMessage":"No soy socio","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '6389026359216632062', 'x-datadog-parent-id': '7718165961372645123', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=7fd70fb86ed51652', 'traceparent': '00-7fd70fb86ed5165258aa619f89b6f0fe-6b1c6f0c9d20b703-00', 'tracestate': 'dd=s:0;p:6b1c6f0c9d20b703', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '35.240.136.56', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '80', 'connection': 'Keep-Alive'}
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50378193399, type=unknown, text_preview='No soy socio'
Nov 21 15:39:53 membership start_watibot4.sh[985940]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '35.240.136.56', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:PARSED DATA: {'waId': '50378193399', 'userMessage': 'No soy socio', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:[DEBUG] Parsed waId: 50378193399, message: 'No soy socio', replyContextId: None, caption: None
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50378193399:f2dc60a35405 (type=text)
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50378193399
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50378193399 (worker PID 985940)
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50378193399 at 2025-11-21 15:39:53.062395
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [MISSED_MESSAGES] Cutoff timestamp (PREVIOUS assistant response) for 50372117927: 2025-11-20 23:24:05+00:00
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [FETCH] Getting messages from WATI API...
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [FETCH] Page 1...
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [SUCCESS] Found 18 messages on page 1
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [FETCH] Page 2...
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [INFO] No more messages found on page 2
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [STATS] Total API messages: 18
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [WEBHOOK] Getting webhook-received messages from database...
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [WEBHOOK] No OpenAI thread found for waId: 50372117927
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [STATS] Webhook messages found: 0
Nov 21 15:39:53 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [COMPARISON] Finding customer messages sent to agents (not webhook)
Nov 21 15:39:53 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [ASSISTANT] Getting assistant responses from OpenAI thread...
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [WEBHOOK] Total webhook interactions (received + sent): 0
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [FILTER] Total API messages with text: 8
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [RESULTS] Customer-to-agent messages found: 8
Nov 21 15:39:53 membership start_watibot4.sh[985940]: ------------------------------------------------------------
Nov 21 15:39:53 membership start_watibot4.sh[985940]: üéØ SUCCESS! Found customer messages sent to human agents:
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [1] 2025-11-21 15:38:46
--
Nov 21 15:39:53 membership start_watibot4.sh[985940]: ‚úÖ Add corresponding human agent responses for full context
Nov 21 15:39:53 membership start_watibot4.sh[985940]: ‚úÖ Format as system messages in OpenAI threads
Nov 21 15:39:53 membership start_watibot4.sh[985940]: [MISSED_MESSAGES] Found 6 messages in gap for 50372117927
Nov 21 15:39:53 membership start_watibot4.sh[985940]: INFO:     35.240.136.56:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:39:58 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:39:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Continued from response resp_07cdc381c358811e00691fa3104a70819492b164b0d7daf376
Nov 21 15:39:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 - Requested: load_additional_modules with call_id: call_Uw3ui1P7oHGjl3HyXHy7WaOA args={"modules":["MODULE_1_CRITICAL_WORKFLOWS"],"reasoning":"User is closing conversation with a thank you; need friendly_goodbye_protocol to respond appropriately."}
Nov 21 15:39:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Skipping MODULE_1_CRITICAL_WORKFLOWS - loaded 1 message(s) ago
Nov 21 15:39:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] All requested modules already loaded - saved tokens
Nov 21 15:40:00 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:40:00 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 15:40:00 membership start_watibot4.sh[985940]: INFO:app.openai_agent:Final response from OpenAI: Ha sido un gusto ayudarle üå¥.
Nov 21 15:40:00 membership start_watibot4.sh[985940]: Que tenga un excelente d√≠a, quedamos a su disposici√≥n cuando lo neces...
Nov 21 15:40:00 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] OpenAI response for 50372117927: 'Ha sido un gusto ayudarle üå¥.  \nQue tenga un excelente d√≠a, quedamos a su disposici√≥n cuando lo necesite ‚òÄÔ∏è'
Nov 21 15:40:00 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50372117927
Nov 21 15:40:01 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50372117927 "HTTP/1.1 200 OK"
Nov 21 15:40:01 membership start_watibot4.sh[985940]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzIxMTc5MjcVAgARGBI2NkRCQTE1QURDMUMzOEUwN0QA","localMessageId":"a451cf6f-cdd9-4a2e-83d9-a361bf1c1e7d","text":"Ha sido un gusto ayudarle üå¥.  \nQue tenga un excelente d√≠a, quedamos a su disposici√≥n cuando lo necesite ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763739600","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"692087844907550e04033e32","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"692087d025103bf109106456","tenantId":"1087","created":"2025-11-21T15:40:00.5743446Z","conversationId":"691fa2bf1d945cd24e46c9d4","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 15:40:01 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50372117927 after 1 attempts
Nov 21 15:40:01 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer cleanup complete for 50372117927, no orphaned messages
Nov 21 15:40:01 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Released processing lock for 50372117927 (worker PID 985940)
Nov 21 15:40:03 membership start_watibot4.sh[985942]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50378193399, message_key=50378193399:f2dc60a35405
Nov 21 15:40:03 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50378193399, type=text, content=No soy socio...
Nov 21 15:40:03 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET] Started timer thread for 50378193399
Nov 21 15:40:03 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET] Successfully forwarded message to processing
Nov 21 15:40:03 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50378193399:f2dc60a35405
Nov 21 15:40:05 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Ok gracias', reply_context='wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBJDMkEzOEEzNzVEOTVBNzU2NDAA', waId=50375638838, owner=False, operatorName=None
Nov 21 15:40:05 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50375638838, message_key=50375638838:d1edbde93d0a (total active: 1)
Nov 21 15:40:05 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:40:05 membership start_watibot4.sh[985940]: INFO:     136.110.25.159:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50375638838","userMessage":"Ok gracias","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '8373947644385207349', 'x-datadog-parent-id': '6234401401365993360', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=62e41f2ec3734290', 'traceparent': '00-62e41f2ec373429074363d03f74ca435-56850b0b139e1790-00', 'tracestate': 'dd=s:0;p:56850b0b139e1790', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '34.124.221.105', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '78', 'connection': 'Keep-Alive'}
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50375638838, type=unknown, text_preview='Ok gracias'
Nov 21 15:40:05 membership start_watibot4.sh[985941]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '34.124.221.105', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:PARSED DATA: {'waId': '50375638838', 'userMessage': 'Ok gracias', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:[DEBUG] Parsed waId: 50375638838, message: 'Ok gracias', replyContextId: None, caption: None
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50375638838:d1edbde93d0a (type=text)
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50375638838
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50375638838 (worker PID 985941)
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50375638838 at 2025-11-21 15:40:05.827425
Nov 21 15:40:05 membership start_watibot4.sh[985941]: INFO:     34.124.221.105:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:40:15 membership start_watibot4.sh[985940]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50375638838, message_key=50375638838:d1edbde93d0a
Nov 21 15:40:15 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50375638838, type=text, content=Ok gracias...
Nov 21 15:40:15 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Started timer thread for 50375638838
Nov 21 15:40:15 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Successfully forwarded message to processing
Nov 21 15:40:15 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50375638838:d1edbde93d0a
Nov 21 15:40:53 membership start_watibot4.sh[985942]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50378193399:f2dc60a35405
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer for 50378193399 started at 2025-11-21 15:39:53.062395, using buffer window of 70s
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50378193399 since 2025-11-21 15:39:48 (looking back 70s)
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 total messages for 50378193399: [('text', '2025-11-21 15:40:03'), ('text', '2025-11-21 15:39:53')]
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 messages within cutoff window for 50378193399: [('text', None), ('text', '')]
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 2 messages from buffer for 50378193399
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Sending combined prompt for 50378193399: 'No soy socio\nNo soy socio'
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50378193399. Agent context will be handled inline.
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.main:[MISSED_MESSAGES_CHECK] 50378193399: Previous webhook at 2025-11-21 15:38:19, time_diff=159.1s
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.main:[MISSED_MESSAGES_CHECK] Less than 5 minutes since previous message for 50378193399
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Attempt 1 to get OpenAI response for 50378193399 (elapsed: 0.0s)
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[DYNAMIC_LOADING] Base modules loaded: 57878 chars, Initial reduction: 67.4%
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Reusing existing conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Found previous response resp_0ccbf886a4829d1c006920879e27788196a2417f385088a4b5 to continue from
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context already injected for conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 15:40:58 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Skipping base_modules at message 2 - using cached from previous_response_id (159.1s since last)
Nov 21 15:41:02 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:41:02 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Continued from response resp_0ccbf886a4829d1c006920879e27788196a2417f385088a4b5
Nov 21 15:41:02 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 - Requested: check_smart_availability with call_id: call_xfPGfxTc772XlO2red5Q8SuH args={"check_in_date":"2025-12-30","check_out_date":"2026-01-01"}
Nov 21 15:41:02 membership start_watibot4.sh[985940]: INFO:app.smart_availability:[SMART_AVAILABILITY] Checking availability for 2025-12-30 to 2026-01-01
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.database_client:Availability for 2025-12-30 to 2026-01-01: {'bungalow_familiar': 'Available', 'bungalow_junior': 'Available', 'habitacion': 'Available'}
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.smart_availability:[SMART_AVAILABILITY] Full period availability: {'bungalow_familiar': 'Available', 'bungalow_junior': 'Available', 'habitacion': 'Available'}
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.smart_availability:[SMART_AVAILABILITY] Any rooms available for full period: True
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 - Requested: get_price_for_date with call_id: call_IyqOqs5ocGsyTYsEduZmBAGi args={"date_str":"2025-12-30"}
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.database_client:Executing query: SELECT lh_adulto, lh_nino, pa_adulto, pa_nino, es_adulto, es_nino
Nov 21 15:41:03 membership start_watibot4.sh[985940]:             FROM tarifarios
Nov 21 15:41:03 membership start_watibot4.sh[985940]:             WHERE STR_TO_DATE(date, '%m/%d/%Y') = %s with params: ('2025-12-30',)
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.database_client:Raw query result for 2025-12-30: {'lh_adulto': '79.00', 'lh_nino': '39.50', 'pa_adulto': '29.00', 'pa_nino': '14.50', 'es_adulto': '74.00', 'es_nino': '37.00'}
Nov 21 15:41:03 membership start_watibot4.sh[985940]: INFO:app.database_client:Prices for 2025-12-30: {'lh_adulto': '79.00', 'lh_nino': '39.50', 'pa_adulto': '29.00', 'pa_nino': '14.50', 'es_adulto': '74.00', 'es_nino': '37.00'}
Nov 21 15:41:05 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50375638838:d1edbde93d0a
Nov 21 15:41:08 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] Timer for 50378193399 started at 2025-11-21 15:40:03.063784, using buffer window of 70s
Nov 21 15:41:08 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50378193399 since 2025-11-21 15:39:58 (looking back 70s)
Nov 21 15:41:08 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 total messages for 50378193399: []
Nov 21 15:41:08 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 messages within cutoff window for 50378193399: []
Nov 21 15:41:08 membership start_watibot4.sh[985942]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 0 messages from buffer for 50378193399
Nov 21 15:41:08 membership start_watibot4.sh[985942]: INFO:app.main:[BUFFER] No messages to process for 50378193399
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] Timer for 50375638838 started at 2025-11-21 15:40:05.827425, using buffer window of 70s
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50375638838 since 2025-11-21 15:40:00 (looking back 70s)
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 total messages for 50375638838: [('text', '2025-11-21 15:40:15'), ('text', '2025-11-21 15:40:05')]
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 messages within cutoff window for 50375638838: [('text', None), ('text', 'wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBJDMkEzOEEzNzVEOTVBNzU2NDAA')]
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 2 messages from buffer for 50375638838
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.main:[REPLY_CONTEXT] Text message has reply context: wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBJDMkEzOEEzNzVEOTVBNzU2NDAA
Nov 21 15:41:10 membership start_watibot4.sh[985941]: INFO:app.main:[REPLY_CONTEXT] Retrieving original message: waId=50375638838, messageId=wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBJDMkEzOEEzNzVEOTVBNzU2NDAA
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:httpx:HTTP Request: GET https://live-mt-server.wati.io/1087/api/v1/getMessages/50375638838 "HTTP/1.1 200 OK"
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[REPLY_CONTEXT] API response status: 200
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[REPLY_CONTEXT] Retrieved 3 messages
Nov 21 15:41:11 membership start_watibot4.sh[985941]: ERROR:app.main:[REPLY_CONTEXT] Error retrieving original message: 'str' object has no attribute 'get'
Nov 21 15:41:11 membership start_watibot4.sh[985941]: Traceback (most recent call last):
Nov 21 15:41:11 membership start_watibot4.sh[985941]:   File "/home/robin/watibot4/app/main.py", line 500, in get_original_message_context
Nov 21 15:41:11 membership start_watibot4.sh[985941]:     if msg.get("whatsappMessageId") == reply_context_id:
Nov 21 15:41:11 membership start_watibot4.sh[985941]: AttributeError: 'str' object has no attribute 'get'
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[REPLY_CONTEXT] No context found for ID: wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBJDMkEzOEEzNzVEOTVBNzU2NDAA
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] Sending combined prompt for 50375638838: 'Ok gracias\nOk gracias'
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50375638838. Agent context will be handled inline.
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[MISSED_MESSAGES_CHECK] 50375638838: Previous webhook at 2025-11-21 15:38:31, time_diff=160.5s
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.main:[MISSED_MESSAGES_CHECK] Less than 5 minutes since previous message for 50375638838
--
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.openai_agent:[OpenAI] Found previous response resp_0fd6e8e4a0a5bc5400692087b2291c8196b35c44f5650220ae to continue from
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context already injected for conversation conv_691fb9ac6e7481969a1bdd4e063e6b930fd6e8e4a0a5bc54
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Sending base_modules at message 24 (new_conv=False, after_context=False, periodic=True, time_gap=False [160.5s since last])
Nov 21 15:41:11 membership start_watibot4.sh[985941]: INFO:openai._base_client:Retrying request to /responses in 0.435801 seconds
Nov 21 15:41:20 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer for 50375638838 started at 2025-11-21 15:40:15.446627, using buffer window of 70s
Nov 21 15:41:20 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50375638838 since 2025-11-21 15:40:10 (looking back 70s)
Nov 21 15:41:20 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 total messages for 50375638838: []
Nov 21 15:41:20 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 messages within cutoff window for 50375638838: []
Nov 21 15:41:20 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 0 messages from buffer for 50375638838
Nov 21 15:41:20 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] No messages to process for 50375638838
Nov 21 15:41:22 membership start_watibot4.sh[985941]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:41:22 membership start_watibot4.sh[985941]: INFO:app.openai_agent:[OpenAI] Continued from response resp_0fd6e8e4a0a5bc5400692087b2291c8196b35c44f5650220ae
Nov 21 15:41:22 membership start_watibot4.sh[985941]: INFO:app.openai_agent:Final response from OpenAI: Con much√≠simo gusto ü••
Nov 21 15:41:22 membership start_watibot4.sh[985941]: Quedamos entonces pendientes de que realice el dep√≥sito de **$235.00** y nos ...
Nov 21 15:41:22 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] OpenAI response for 50375638838: 'Con much√≠simo gusto ü••\n\nQuedamos entonces pendientes de que realice el dep√≥sito de **$235.00** y nos env√≠e por aqu√≠ la foto del comprobante cuando lo tenga. En cuanto lo recibamos, seguimos con el proceso para dejar su estad√≠a del **31 de diciembre al 2 de enero** registrada correctamente üå¥\n\nSi en el camino le surge cualquier otra duda, aqu√≠ estoy para ayudarle ‚òÄÔ∏è'
Nov 21 15:41:22 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50375638838
Nov 21 15:41:23 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 15:41:23 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 15:41:23 membership start_watibot4.sh[985940]: INFO:app.openai_agent:Final response from OpenAI: Perfecto, gracias por confirmarme que no es socio üå¥
Nov 21 15:41:23 membership start_watibot4.sh[985940]: Para su estad√≠a **del 30 de diciembre al 1 de e...
Nov 21 15:41:23 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] OpenAI response for 50378193399: 'Perfecto, gracias por confirmarme que no es socio üå¥\n\nPara su estad√≠a **del 30 de diciembre al 1 de enero (2 noches) para 5 adultos y 1 beb√© (0‚Äì5 a√±os)** le comento:\n\n- Tenemos **disponibilidad completa** para esas fechas ‚úÖ  \n- Por tama√±o de grupo, la opci√≥n ideal es el **Bungalow Familiar** (dise√±ado justo para grupos de 5 a 8 personas).\n\nEl paquete recomendado es el **Paquete Las Hojas**, que incluye por **cada adulto y por noche**:  \n- üõèÔ∏è Alojamiento  \n- üçΩÔ∏è Cena, desayuno y almuerzo  \n- ü•§ **6 bebidas** (agua, caf√©, soda, refrescos naturales o cervezas nacionales)  \n- üç∞ **2 postres**  \n- üåä Uso completo de todas las instalaciones del resort\n\nPara esta fecha, la tarifa base del **Paquete Las Hojas** es de **$79.00 por adulto por noche**.  \nComo la estad√≠a es de **2 noches** y son **5 adultos**, el c√°lculo ser√≠a:\n\n- 79.00 √ó 5 adultos √ó 2 noches = **$790.00** en total por los 5 adultos (el beb√© no paga).\n\n**Importante sobre el beb√© (0‚Äì5 a√±os):**  \nLos beb√©s **no pagan paquete y no cuentan para la ocupaci√≥n**, pero eso significa que **no tienen alimentaci√≥n incluida**. Puede:\n- Agregar un **paquete de ni√±o** (6‚Äì10 a√±os) si desea que el beb√© tenga comidas incluidas, **o**\n- Pedirle platillos del men√∫ y se pagan aparte al hacer check-out.\n\nAdem√°s, como sus fechas son de **Navidad y A√±o Nuevo**, durante esos d√≠as tendremos **actividades especiales**: m√∫sica en vivo, shows, entretenimiento familiar, DJ y m√°s. üéÑ‚ú® Si desea, luego le detallo la programaci√≥n d√≠a por d√≠a.\n\n¬øLe gustar√≠a que procedamos con la **reserva en Bungalow Familiar con Paquete Las Hojas** por un total de **$790.00**? ‚òÄÔ∏è'
Nov 21 15:41:23 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50378193399
Nov 21 15:41:24 membership start_watibot4.sh[985941]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50375638838 "HTTP/1.1 200 OK"
Nov 21 15:41:24 membership start_watibot4.sh[985941]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzU2Mzg4MzgVAgARGBI3OTgyNTY3OENBRTk1RDM1N0YA","localMessageId":"0cdf6b8b-d0a8-48a9-96a3-205ddab2c27d","text":"Con much√≠simo gusto ü••\n\nQuedamos entonces pendientes de que realice el dep√≥sito de **$235.00** y nos env√≠e por aqu√≠ la foto del comprobante cuando lo tenga. En cuanto lo recibamos, seguimos con el proceso para dejar su estad√≠a del **31 de diciembre al 2 de enero** registrada correctamente üå¥\n\nSi en el camino le surge cualquier otra duda, aqu√≠ estoy para ayudarle ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763739683","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"691fb9697f0c0cebc9ec8f63","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"69208823b94a72d5a9ad090d","tenantId":"1087","created":"2025-11-21T15:41:23.1288021Z","conversationId":"691fb9691d945cd24e46e954","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 15:41:24 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50375638838 after 1 attempts
Nov 21 15:41:24 membership start_watibot4.sh[985941]: INFO:app.main:[BUFFER] Timer cleanup complete for 50375638838, no orphaned messages
Nov 21 15:41:24 membership start_watibot4.sh[985941]: INFO:app.message_buffer:[LOCK] Released processing lock for 50375638838 (worker PID 985941)
Nov 21 15:41:24 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50378193399 "HTTP/1.1 200 OK"
Nov 21 15:41:24 membership start_watibot4.sh[985940]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzgxOTMzOTkVAgARGBJDNEM1MUU5NTU5M0YwRTg5M0YA","localMessageId":"cb663a8d-1e68-4141-9c26-e8c85145b318","text":"Perfecto, gracias por confirmarme que no es socio üå¥\n\nPara su estad√≠a **del 30 de diciembre al 1 de enero (2 noches) para 5 adultos y 1 beb√© (0‚Äì5 a√±os)** le comento:\n\n- Tenemos **disponibilidad completa** para esas fechas ‚úÖ  \n- Por tama√±o de grupo, la opci√≥n ideal es el **Bungalow Familiar** (dise√±ado justo para grupos de 5 a 8 personas).\n\nEl paquete recomendado es el **Paquete Las Hojas**, que incluye por **cada adulto y por noche**:  \n- üõèÔ∏è Alojamiento  \n- üçΩÔ∏è Cena, desayuno y almuerzo  \n- ü•§ **6 bebidas** (agua, caf√©, soda, refrescos naturales o cervezas nacionales)  \n- üç∞ **2 postres**  \n- üåä Uso completo de todas las instalaciones del resort\n\nPara esta fecha, la tarifa base del **Paquete Las Hojas** es de **$79.00 por adulto por noche**.  \nComo la estad√≠a es de **2 noches** y son **5 adultos**, el c√°lculo ser√≠a:\n\n- 79.00 √ó 5 adultos √ó 2 noches = **$790.00** en total por los 5 adultos (el beb√© no paga).\n\n**Importante sobre el beb√© (0‚Äì5 a√±os):**  \nLos beb√©s **no pagan paquete y no cuentan para la ocupaci√≥n**, pero eso significa que **no tienen alimentaci√≥n incluida**. Puede:\n- Agregar un **paquete de ni√±o** (6‚Äì10 a√±os) si desea que el beb√© tenga comidas incluidas, **o**\n- Pedirle platillos del men√∫ y se pagan aparte al hacer check-out.\n\nAdem√°s, como sus fechas son de **Navidad y A√±o Nuevo**, durante esos d√≠as tendremos **actividades especiales**: m√∫sica en vivo, shows, entretenimiento familiar, DJ y m√°s. üéÑ‚ú® Si desea, luego le detallo la programaci√≥n d√≠a por d√≠a.\n\n¬øLe gustar√≠a que procedamos con la **reserva en Bungalow Familiar con Paquete Las Hojas** por un total de **$790.00**? ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763739683","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"692087535507f29f73e67fb4","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"692088231667b1eaf8978666","tenantId":"1087","created":"2025-11-21T15:41:23.523129Z","conversationId":"692087531d945cd24e491570","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 15:41:24 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50378193399 after 1 attempts
Nov 21 15:41:24 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer cleanup complete for 50378193399, no orphaned messages
Nov 21 15:41:24 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Released processing lock for 50378193399 (worker PID 985940)
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Son todos adultos', reply_context='', waId=50378131498, owner=False, operatorName=None
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50378131498, message_key=50378131498:3591b024af81 (total active: 1)
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:     35.240.187.225:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50378131498","userMessage":"Son todos adultos","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '14476024640862526763', 'x-datadog-parent-id': '13947937526055462636', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=b78139853fafd056', 'traceparent': '00-b78139853fafd056c8e52bb6ae699d2b-c1910747d5e066ec-00', 'tracestate': 'dd=s:0;p:c1910747d5e066ec', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '136.110.11.254', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '85', 'connection': 'Keep-Alive'}
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:QUERY PARAMS: {}
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50378131498, type=unknown, text_preview='Son todos adultos'
Nov 21 15:41:26 membership start_watibot4.sh[985940]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '136.110.11.254', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:PARSED DATA: {'waId': '50378131498', 'userMessage': 'Son todos adultos', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[DEBUG] Parsed waId: 50378131498, message: 'Son todos adultos', replyContextId: None, caption: None
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50378131498:3591b024af81 (type=text)
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Marked message as processed: 50378131498:3591b024af81
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50378131498
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50378131498 (worker PID 985940)
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50378131498 at 2025-11-21 15:41:26.420505
Nov 21 15:41:26 membership start_watibot4.sh[985940]: INFO:     136.110.11.254:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 15:41:35 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Del 20 al 21', reply_context='', waId=50378131498, owner=False, operatorName=None
Nov 21 15:41:35 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50378131498, message_key=50378131498:43a056dbf9ea (total active: 2)
--
Nov 21 16:01:19 membership start_watibot4.sh[985938]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Y en qu√© me puede ayudar usted', reply_context='', waId=50372163339, owner=False, operatorName=None
Nov 21 16:01:19 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50372163339, message_key=50372163339:212a86fc71ee (total active: 1)
Nov 21 16:01:19 membership start_watibot4.sh[985938]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 16:01:19 membership start_watibot4.sh[985938]: INFO:     35.240.135.59:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 16:01:29 membership start_watibot4.sh[985938]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50372163339, message_key=50372163339:212a86fc71ee
Nov 21 16:01:29 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50372163339, type=text, content=Y en qu√© me puede ayudar usted...
Nov 21 16:01:29 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET] Started timer thread for 50372163339
Nov 21 16:01:29 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET] Successfully forwarded message to processing
Nov 21 16:01:29 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50372163339:212a86fc71ee
Nov 21 16:02:19 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50372163339:212a86fc71ee
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Timer for 50372163339 started at 2025-11-21 16:01:29.562487, using buffer window of 70s
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50372163339 since 2025-11-21 16:01:24 (looking back 70s)
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 1 total messages for 50372163339: [('text', '2025-11-21 16:01:29')]
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 1 messages within cutoff window for 50372163339: [('text', '')]
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 1 messages from buffer for 50372163339
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Sending combined prompt for 50372163339: 'Y en qu√© me puede ayudar usted'
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50372163339. Agent context will be handled inline.
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.main:[MISSED_MESSAGES_CHECK] 50372163339: Previous webhook at 2025-11-21 15:57:43, time_diff=291.6s
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.main:[MISSED_MESSAGES_CHECK] Less than 5 minutes since previous message for 50372163339
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Attempt 1 to get OpenAI response for 50372163339 (elapsed: 0.0s)
Nov 21 16:02:34 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Tiene im√°genes del bungalow?', reply_context='', waId=50378193399, owner=False, operatorName=None
Nov 21 16:02:34 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50378193399, message_key=50378193399:316101618d0b (total active: 1)
Nov 21 16:02:34 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [MISSED_MESSAGES] Cutoff timestamp (PREVIOUS assistant response) for 50372163339: 2025-11-21 11:09:29+00:00
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [FETCH] Getting messages from WATI API...
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [FETCH] Page 1...
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [SUCCESS] Found 45 messages on page 1
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [FETCH] Page 2...
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [INFO] No more messages found on page 2
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [STATS] Total API messages: 45
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [WEBHOOK] Getting webhook-received messages from database...
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [WEBHOOK] No OpenAI thread found for waId: 50372163339
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [STATS] Webhook messages found: 0
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [COMPARISON] Finding customer messages sent to agents (not webhook)
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [ASSISTANT] Getting assistant responses from OpenAI thread...
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [WEBHOOK] Total webhook interactions (received + sent): 0
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [FILTER] Total API messages with text: 23
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [RESULTS] Customer-to-agent messages found: 23
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ------------------------------------------------------------
Nov 21 16:02:34 membership start_watibot4.sh[985940]: üéØ SUCCESS! Found customer messages sent to human agents:
--
Nov 21 16:02:34 membership start_watibot4.sh[985940]:     ‚úÖ NOT FOUND IN WEBHOOK - Likely sent to human agent
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ... and 13 more messages
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [SUMMARY] MESSAGE CLASSIFICATION
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:02:34 membership start_watibot4.sh[985940]: Total API messages analyzed: 45
Nov 21 16:02:34 membership start_watibot4.sh[985940]: API messages with text: 23
Nov 21 16:02:34 membership start_watibot4.sh[985940]: Webhook interactions (received + sent): 0
Nov 21 16:02:34 membership start_watibot4.sh[985940]: Customer-to-agent messages: 23
Nov 21 16:02:34 membership start_watibot4.sh[985940]: üéØ NEXT STEPS:
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ‚úÖ Implement injection of these 23 customer-to-agent messages
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ‚úÖ Add corresponding human agent responses for full context
Nov 21 16:02:34 membership start_watibot4.sh[985940]: ‚úÖ Format as system messages in OpenAI threads
Nov 21 16:02:34 membership start_watibot4.sh[985940]: [MISSED_MESSAGES] Found 4 messages in gap for 50372163339
Nov 21 16:02:34 membership start_watibot4.sh[985940]: INFO:     136.110.7.244:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[DYNAMIC_LOADING] Base modules loaded: 57878 chars, Initial reduction: 67.4%
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[OpenAI] Reusing existing conversation conv_691f0e6450708194a4a4a6b5fdecaddc022b578a0510cf66
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[OpenAI] Found previous response resp_022b578a0510cf660069208c469b60819495a5d989957b1697 to continue from
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context already injected for conversation conv_691f0e6450708194a4a4a6b5fdecaddc022b578a0510cf66
Nov 21 16:02:34 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Skipping base_modules at message 7 - using cached from previous_response_id (291.6s since last)
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50378193399","userMessage":"Tiene im\xc3\xa1genes del bungalow?","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '3085027407965314249', 'x-datadog-parent-id': '14419173982543549064', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=a216d1d39411bd94', 'traceparent': '00-a216d1d39411bd942ad03815161ddcc9-c81b325750101288-00', 'tracestate': 'dd=s:0;p:c81b325750101288', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '34.177.100.187', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '97', 'connection': 'Keep-Alive'}
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:QUERY PARAMS: {}
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50378193399, type=unknown, text_preview='Tiene im√°genes del bungalow?'
Nov 21 16:02:35 membership start_watibot4.sh[985940]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '34.177.100.187', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:PARSED DATA: {'waId': '50378193399', 'userMessage': 'Tiene im√°genes del bungalow?', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[DEBUG] Parsed waId: 50378193399, message: 'Tiene im√°genes del bungalow?', replyContextId: None, caption: None
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50378193399:316101618d0b (type=text)
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Marked message as processed: 50378193399:316101618d0b
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50378193399
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50378193399 (worker PID 985940)
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50378193399 at 2025-11-21 16:02:35.444780
Nov 21 16:02:35 membership start_watibot4.sh[985940]: INFO:     34.177.100.187:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 16:02:44 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Message already processed by main webhook: 50378193399:316101618d0b
Nov 21 16:02:44 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50378193399:316101618d0b
Nov 21 16:02:46 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 16:02:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[OpenAI] Continued from response resp_022b578a0510cf660069208c469b60819495a5d989957b1697
Nov 21 16:02:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[Tool] Round 1 - Requested: load_additional_modules with call_id: call_PNoCNauHJzWTnhhB867vwtzY args={"modules":["MODULE_4_INFORMATION"],"reasoning":"User is asking generally what the assistant can help with; need overall hotel information and service scope to describe support areas."}
Nov 21 16:02:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[DYNAMIC_LOADING] Loaded full module: MODULE_4_INFORMATION
Nov 21 16:02:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Saved 1 loaded modules at message 7
Nov 21 16:02:55 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 16:02:55 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 16:02:55 membership start_watibot4.sh[985938]: INFO:app.openai_agent:Final response from OpenAI: Puedo ayudarle con pr√°cticamente todo lo relacionado a su visita a Las Hojas Resort üå¥, por ejemplo:
Nov 21 16:02:55 membership start_watibot4.sh[985938]: ...
Nov 21 16:02:55 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] OpenAI response for 50372163339: 'Puedo ayudarle con pr√°cticamente todo lo relacionado a su visita a Las Hojas Resort üå¥, por ejemplo:\n\n1. **Informaci√≥n y dudas generales**\n   - Explicarle nuestros paquetes (Pasad√≠a y hospedaje).\n   - Contarle qu√© √°reas y servicios tiene el hotel (piscinas, playa, restaurante, toboganes, etc.).\n   - Horarios de restaurante, bar, piscinas, reglas b√°sicas, toallas, Wi‚ÄëFi, estacionamiento, etc.\n\n2. **Promociones y planificaci√≥n de visita**\n   - Explicarle c√≥mo funciona la promoci√≥n 5x4 del Paquete Pasad√≠a.\n   - Orientarle sobre qu√© paquete le conviene m√°s seg√∫n si viene en pareja, familia o grupo.\n\n3. **Cotizaciones y paso siguiente para reservar**\n   - Hacerle una cotizaci√≥n seg√∫n la fecha que quiera venir y cu√°ntas personas son.\n   - Explicarle qu√© incluye cada paquete para adultos y para ni√±os.\n\nSi me cuenta qu√© est√° pensando hacer (por ejemplo: ‚Äúquiero ir un domingo de pasad√≠a con mi familia‚Äù o ‚Äúquiero quedarme a dormir una noche‚Äù), con gusto empiezo por ah√≠ y le voy guiando paso a paso. ‚òÄÔ∏è'
Nov 21 16:02:55 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50372163339
Nov 21 16:02:56 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50372163339 "HTTP/1.1 200 OK"
Nov 21 16:02:56 membership start_watibot4.sh[985938]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzIxNjMzMzkVAgARGBJEOUZGNjY1MEZGRkJCM0MyREIA","localMessageId":"44f8089e-0ccf-4347-8bac-75bdf7374c1a","text":"Puedo ayudarle con pr√°cticamente todo lo relacionado a su visita a Las Hojas Resort üå¥, por ejemplo:\n\n1. **Informaci√≥n y dudas generales**\n   - Explicarle nuestros paquetes (Pasad√≠a y hospedaje).\n   - Contarle qu√© √°reas y servicios tiene el hotel (piscinas, playa, restaurante, toboganes, etc.).\n   - Horarios de restaurante, bar, piscinas, reglas b√°sicas, toallas, Wi‚ÄëFi, estacionamiento, etc.\n\n2. **Promociones y planificaci√≥n de visita**\n   - Explicarle c√≥mo funciona la promoci√≥n 5x4 del Paquete Pasad√≠a.\n   - Orientarle sobre qu√© paquete le conviene m√°s seg√∫n si viene en pareja, familia o grupo.\n\n3. **Cotizaciones y paso siguiente para reservar**\n   - Hacerle una cotizaci√≥n seg√∫n la fecha que quiera venir y cu√°ntas personas son.\n   - Explicarle qu√© incluye cada paquete para adultos y para ni√±os.\n\nSi me cuenta qu√© est√° pensando hacer (por ejemplo: ‚Äúquiero ir un domingo de pasad√≠a con mi familia‚Äù o ‚Äúquiero quedarme a dormir una noche‚Äù), con gusto empiezo por ah√≠ y le voy guiando paso a paso. ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763740975","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"69208becc352e6ce045abd85","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"69208d2f3c5cbf0157ce3896","tenantId":"1087","created":"2025-11-21T16:02:55.4210534Z","conversationId":"691f0e211d945cd24e453c84","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 16:02:56 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50372163339 after 1 attempts
Nov 21 16:02:56 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Timer cleanup complete for 50372163339, no orphaned messages
Nov 21 16:02:56 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[LOCK] Released processing lock for 50372163339 (worker PID 985938)
Nov 21 16:03:38 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption="Give me information about this season's promotions", reply_context='', waId=50375504735, owner=False, operatorName=None
Nov 21 16:03:38 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50375504735, message_key=50375504735:6682f2f60b0c (total active: 1)
Nov 21 16:03:38 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 16:03:38 membership start_watibot4.sh[985940]: INFO:     35.240.135.59:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50375504735","userMessage":"Give me information about this season\'s promotions","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '15091136304050796662', 'x-datadog-parent-id': '14384091920837204029', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=fa0a0819b913c66a', 'traceparent': '00-fa0a0819b913c66ad16e7c8323f2f876-c79e8f644e11583d-00', 'tracestate': 'dd=s:0;p:c79e8f644e11583d', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '34.177.107.137', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '118', 'connection': 'Keep-Alive'}
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:QUERY PARAMS: {}
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50375504735, type=unknown, text_preview="Give me information about this season's promotions"
Nov 21 16:03:38 membership start_watibot4.sh[985938]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '34.177.107.137', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:PARSED DATA: {'waId': '50375504735', 'userMessage': "Give me information about this season's promotions", 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:[DEBUG] Parsed waId: 50375504735, message: "Give me information about this season's promotions", replyContextId: None, caption: None
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50375504735:6682f2f60b0c (type=text)
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50375504735
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50375504735 (worker PID 985938)
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50375504735 at 2025-11-21 16:03:38.480455
Nov 21 16:03:38 membership start_watibot4.sh[985938]: INFO:     34.177.107.137:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer for 50378193399 started at 2025-11-21 16:02:35.444780, using buffer window of 70s
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50378193399 since 2025-11-21 16:02:30 (looking back 70s)
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 1 total messages for 50378193399: [('text', '2025-11-21 16:02:35')]
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 1 messages within cutoff window for 50378193399: [('text', None)]
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 1 messages from buffer for 50378193399
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Sending combined prompt for 50378193399: 'Tiene im√°genes del bungalow?'
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50378193399. Agent context will be handled inline.
Nov 21 16:03:40 membership start_watibot4.sh[985940]: INFO:app.main:[MISSED_MESSAGES_CHECK] 50378193399: Previous webhook at 2025-11-21 15:40:03, time_diff=1417.5s
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.main:[MISSED_MESSAGES_CHECK] Found 1962 chars of missed messages for 50378193399
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Attempt 1 to get OpenAI response for 50378193399 (elapsed: 0.0s)
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[DYNAMIC_LOADING] Base modules loaded: 57878 chars, Initial reduction: 67.4%
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Reusing existing conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Found previous response resp_0ccbf886a4829d1c006920880f83208196ab00e949d5a97a42 to continue from
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context already injected for conversation conv_69208796d2648196a27df447acab0bce0ccbf886a4829d1c
Nov 21 16:03:42 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Sending base_modules at message 3 (new_conv=False, after_context=False, periodic=True, time_gap=False [1417.5s since last])
Nov 21 16:03:46 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 16:03:46 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[OpenAI] Continued from response resp_0ccbf886a4829d1c006920880f83208196ab00e949d5a97a42
Nov 21 16:03:46 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 - Requested: send_bungalow_pictures with call_id: call_NonphyjM3T0DZ9dHt5zBtioV args={"bungalow_type":"Bungalow Familiar"}
Nov 21 16:03:46 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[PHONE_FIX] WATI user - Injecting phone_number for send_bungalow_pictures: 50378193399
Nov 21 16:03:46 membership start_watibot4.sh[985940]: INFO:app.openai_agent:Found 7 pictures for Bungalow Familiar. Target -> channel=None, subscriber_id=None, phone_number=50378193399
Nov 21 16:03:48 membership start_watibot4.sh[985940]: WARNING:app.main:[SAFETY_NET] WATI hiccup detected! Message not received at main webhook after 10s: wa_id=50375504735, message_key=50375504735:6682f2f60b0c
Nov 21 16:03:48 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Forwarding to message buffer: wa_id=50375504735, type=text, content=Give me information about this season's promotions...
Nov 21 16:03:48 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Started timer thread for 50375504735
Nov 21 16:03:48 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Successfully forwarded message to processing
Nov 21 16:03:48 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50375504735:6682f2f60b0c
Nov 21 16:03:51 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:03:51 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_cuarto1.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBI1M0UyMUEyRDUzODBDRThERUMA', 'localMessageId': '8569693e-860c-4aa1-936a-0f864f963cde', 'text': 'data/images/8a8243b9-e767-420c-aad0-617a88082d42.jpg', 'media': {'id': '1525635055455643', 'mimeType': 'image/jpeg', 'caption': 'Habitaci√≥n 1 - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741028', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d64f35337572f88b2e6', 'tenantId': '1087', 'created': '2025-11-21T16:03:48.1912757Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:03:57 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:03:57 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_cuarto2.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBJBQTdEMkM3Q0VCRjQwNzFDMkIA', 'localMessageId': 'a1ddf61d-55a4-4db1-9a4c-9c1fc8dfd599', 'text': 'data/images/a840978a-f175-4008-9d04-b243ec18d450.jpg', 'media': {'id': '1524006245338447', 'mimeType': 'image/jpeg', 'caption': 'Habitaci√≥n 2 - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741034', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d6ac9505ac2173d91da', 'tenantId': '1087', 'created': '2025-11-21T16:03:54.0034834Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:04:03 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:04:03 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_livingroom.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBI0MkVEN0Y2MjBFQjBFMjJERTYA', 'localMessageId': '8fc640ee-da4a-466c-8246-1a159124b316', 'text': 'data/images/3e788338-d930-4e8e-a20c-71a867ffc125.jpg', 'media': {'id': '1181503523309239', 'mimeType': 'image/jpeg', 'caption': 'Sala de Estar - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741040', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d7006655ce02a92c224', 'tenantId': '1087', 'created': '2025-11-21T16:04:00.2302267Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:04:09 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:04:09 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_livingroom_2.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBI3MUM1NDBFNENGNDE1NUNCNzQA', 'localMessageId': '8bba7025-59bc-4dfa-93af-e2eda74461e9', 'text': 'data/images/cae3e7ff-5c81-4d92-a982-604126fb56d4.jpg', 'media': {'id': '727606607024503', 'mimeType': 'image/jpeg', 'caption': 'Sala de Estar 2 - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741046', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d752c3c01bd6bd78447', 'tenantId': '1087', 'created': '2025-11-21T16:04:05.8145246Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:04:14 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:04:14 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_masterbedroom.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBI5M0IyQTlDOTJGRDNBMkM3NDEA', 'localMessageId': 'd68aca09-3cd6-4191-b649-66e8c0c046e1', 'text': 'data/images/ba3b145b-5950-44ec-a644-4efd7923c4d8.jpg', 'media': {'id': '1837706306846657', 'mimeType': 'image/jpeg', 'caption': 'Habitaci√≥n Principal - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741052', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d7bae69de3b8a6d26a4', 'tenantId': '1087', 'created': '2025-11-21T16:04:11.6783162Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:04:19 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:04:19 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_outside.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBJBOTVBQ0IxMzBBMjYzNkNBQkMA', 'localMessageId': 'e5ec05bf-4a9b-4f83-9b3f-a1f8fcb6499a', 'text': 'data/images/d8345cfa-bfe6-48b8-b866-fa82d253fa17.jpg', 'media': {'id': '758995253868463', 'mimeType': 'image/jpeg', 'caption': 'Vista Exterior - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741057', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d80b17f33c2fa8aec2a', 'tenantId': '1087', 'created': '2025-11-21T16:04:16.7652065Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:04:25 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionFile/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:04:25 membership start_watibot4.sh[985940]: INFO:root:Successfully sent file '/home/robin/watibot4/app/resources/pictures/bungalow_familiar/bungalow_familiar_terrace.jpeg' to 50378193399. Response: {'result': True, 'message': {'whatsappMessageId': 'wamid.HBgLNTAzNzgxOTMzOTkVAgARGBIyMTlEQjBFMjUzQ0Y5RTQ1MEMA', 'localMessageId': '2a216a0a-b28b-48f8-9027-edaf8fc7e6aa', 'text': 'data/images/160c67eb-e23d-4dd5-8a77-337e7355cf02.jpg', 'media': {'id': '1566940407643917', 'mimeType': 'image/jpeg', 'caption': 'Terraza - Bungalow Familiar'}, 'messageContact': None, 'location': None, 'type': 'image', 'time': '1763741062', 'status': 1, 'statusString': 'SENT', 'isOwner': True, 'botType': None, 'isUnread': False, 'ticketId': '692087535507f29f73e67fb4', 'avatarUrl': None, 'assignedId': '605080c2ac6a43ee20c4d7ab', 'operatorName': 'Las Hojas Resort & Beach Club Admin', 'replyContextId': None, 'sourceType': 0, 'failedDetail': None, 'messageReferral': None, 'googleAdsReferral': None, 'tikTokAdsReferral': None, 'messageProducts': None, 'orderProducts': None, 'orderDetails': None, 'paymentStatus': None, 'interactiveData': None, 'referenceOrderId': None, 'isDeleted': False, 'replyButtonPayload': None, 'reactions': None, 'audioTranscriptionStatus': None, 'filePath': None, 'isDelayed': False, 'translationText': None, 'translationStatus': 0, 'translateTo': None, 'callDirection': None, 'callEvent': None, 'callSession': None, 'callDuration': 0, 'callStatus': None, 'callStartTime': 0, 'callEndTime': 0, 'callAcceptedBy': None, 'callRejectedBy': None, 'callInitiatedBy': None, 'isCallMadeByExternalAgent': False, 'callPermissionReply': None, 'id': '69208d86b17f33c2fa8aece6', 'tenantId': '1087', 'created': '2025-11-21T16:04:22.3292022Z', 'conversationId': '692087531d945cd24e491570', 'channelId': None, 'channelType': 0, 'importTaskId': None}}
Nov 21 16:04:30 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 16:04:30 membership start_watibot4.sh[985940]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 16:04:30 membership start_watibot4.sh[985940]: INFO:app.openai_agent:Final response from OpenAI: Con mucho gusto üå¥ Ya le compartimos algunas fotos del **Bungalow Familiar** para que pueda ver mejor...
Nov 21 16:04:30 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] OpenAI response for 50378193399: 'Con mucho gusto üå¥ Ya le compartimos algunas fotos del **Bungalow Familiar** para que pueda ver mejor el espacio y las hamacas en la terraza.\n\nSi lo desea, con base en lo que ya revisamos (2 noches, 5 adultos y 1 beb√©, del 30 de diciembre al 1 de enero por **$790.00** con Paquete Las Hojas), podemos avanzar de una vez con la reserva.  \n\nSi desea continuar, por favor ind√≠queme:\n- Nombre completo (seg√∫n DUI o pasaporte)\n- N√∫mero de documento (DUI o pasaporte)\n- Ciudad de residencia\n- Nacionalidad\n- Correo electr√≥nico\n\nY tambi√©n c√≥mo prefiere pagar:\n- Tarjeta (enlace de pago CompraClick)\n- Dep√≥sito/transferencia bancaria\n\nCon eso le ayudo a dejar todo listo ‚òÄÔ∏è'
Nov 21 16:04:30 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50378193399
Nov 21 16:04:31 membership start_watibot4.sh[985940]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50378193399 "HTTP/1.1 200 OK"
Nov 21 16:04:31 membership start_watibot4.sh[985940]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzgxOTMzOTkVAgARGBI3Rjk2RTQ5RDMwMzFBRDkwRjUA","localMessageId":"f99c4bac-bb19-4626-a5ef-1f89f16e53bd","text":"Con mucho gusto üå¥ Ya le compartimos algunas fotos del **Bungalow Familiar** para que pueda ver mejor el espacio y las hamacas en la terraza.\n\nSi lo desea, con base en lo que ya revisamos (2 noches, 5 adultos y 1 beb√©, del 30 de diciembre al 1 de enero por **$790.00** con Paquete Las Hojas), podemos avanzar de una vez con la reserva.  \n\nSi desea continuar, por favor ind√≠queme:\n- Nombre completo (seg√∫n DUI o pasaporte)\n- N√∫mero de documento (DUI o pasaporte)\n- Ciudad de residencia\n- Nacionalidad\n- Correo electr√≥nico\n\nY tambi√©n c√≥mo prefiere pagar:\n- Tarjeta (enlace de pago CompraClick)\n- Dep√≥sito/transferencia bancaria\n\nCon eso le ayudo a dejar todo listo ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763741071","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"692087535507f29f73e67fb4","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"69208d8ed167b969219bf69a","tenantId":"1087","created":"2025-11-21T16:04:30.84556Z","conversationId":"692087531d945cd24e491570","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 16:04:31 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50378193399 after 1 attempts
Nov 21 16:04:31 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] Timer cleanup complete for 50378193399, no orphaned messages
Nov 21 16:04:31 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Released processing lock for 50378193399 (worker PID 985940)
Nov 21 16:04:38 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Cleaned up message entry: 50375504735:6682f2f60b0c
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Timer for 50375504735 started at 2025-11-21 16:03:38.480455, using buffer window of 70s
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Retrieving messages for 50375504735 since 2025-11-21 16:03:33 (looking back 70s)
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 total messages for 50375504735: [('text', '2025-11-21 16:03:48'), ('text', '2025-11-21 16:03:38')]
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 2 messages within cutoff window for 50375504735: [('text', None), ('text', '')]
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 2 messages from buffer for 50375504735
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Sending combined prompt for 50375504735: "Give me information about this season's promotions\nGive me information about this season's promotions"
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.main:[AGENT_CONTEXT] History already imported for 50375504735. Agent context will be handled inline.
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.main:[MISSED_MESSAGES_CHECK] No previous webhook timestamp for 50375504735 (first message)
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Attempt 1 to get OpenAI response for 50375504735 (elapsed: 0.0s)
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[DYNAMIC_LOADING] Base modules loaded: 57878 chars, Initial reduction: 67.4%
Nov 21 16:04:43 membership start_watibot4.sh[985938]: WARNING:app.openai_agent:[OpenAI] Invalid thread_id format: 50375504735. Will create new conversation.
Nov 21 16:04:43 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[OpenAI] Creating new conversation for 50375504735
Nov 21 16:04:44 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/conversations "HTTP/1.1 200 OK"
Nov 21 16:04:44 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[OpenAI] Created conversation conv_69208d9c0d088193ab04242e6e875d080ba95b667ba00287
Nov 21 16:04:44 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[OpenAI] No previous response ID found in local storage
Nov 21 16:04:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[AGENT_CONTEXT] Injecting agent context for conversation conv_69208d9c0d088193ab04242e6e875d080ba95b667ba00287
Nov 21 16:04:46 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 16:04:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[AGENT_CONTEXT] Agent context successfully injected for conversation conv_69208d9c0d088193ab04242e6e875d080ba95b667ba00287
Nov 21 16:04:46 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[MODULE_OPTIMIZATION] Sending base_modules at message 1 (new_conv=True, after_context=True, periodic=False, time_gap=None [N/A since last])
--
Nov 21 16:04:53 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 total messages for 50375504735: []
Nov 21 16:04:53 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Found 0 messages within cutoff window for 50375504735: []
Nov 21 16:04:53 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[BUFFER_DEBUG] Deleted 0 messages from buffer for 50375504735
Nov 21 16:04:53 membership start_watibot4.sh[985940]: INFO:app.main:[BUFFER] No messages to process for 50375504735
Nov 21 16:04:57 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Nov 21 16:04:57 membership start_watibot4.sh[985938]: INFO:app.openai_agent:[Tool] Round 1 complete. Checking for more tool calls...
Nov 21 16:04:57 membership start_watibot4.sh[985938]: INFO:app.openai_agent:Final response from OpenAI: Claro que s√≠ üå¥
Nov 21 16:04:57 membership start_watibot4.sh[985938]: En esta temporada contamos con:
Nov 21 16:04:57 membership start_watibot4.sh[985938]: 1) **Paquete Pasad√≠a (Day Pass)**
Nov 21 16:04:57 membership start_watibot4.sh[985938]: Ideal para veni...
Nov 21 16:04:57 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] OpenAI response for 50375504735: 'Claro que s√≠ üå¥\n\nEn esta temporada contamos con:\n\n1) **Paquete Pasad√≠a (Day Pass)**  \nIdeal para venir solo por el d√≠a, sin hospedaje. Incluye por persona:  \n- 1 almuerzo üçΩÔ∏è  \n- 3 bebidas (agua, caf√©, soda, refrescos naturales o cervezas nacionales) ü•§  \n- 1 postre üç∞  \n- Uso de todas las √°reas comunes de 7:00 a.m. a 9:00 p.m.  \n- Acceso a piscinas, playa privada y vestidores  \n\n2) **Paquete Las Hojas (con alojamiento)**  \nPensado para disfrutar una estad√≠a completa:  \n- Alojamiento en habitaci√≥n o bungalow  \n- Cena, desayuno y almuerzo por noche  \n- 6 bebidas por persona por noche (agua, caf√©, soda, refrescos naturales o cervezas nacionales)  \n- 2 postres por persona por noche  \n- Uso completo de todas las instalaciones  \n\n3) **Paquete Rom√°ntico (para parejas)** üíï  \nIncluye **todo lo del Paquete Las Hojas** (cena, desayuno, almuerzo, 6 bebidas y 2 postres por persona por noche)  \n+ decoraci√≥n y ambientaci√≥n rom√°ntica especial en la habitaci√≥n.\n\nAdem√°s, tenemos activa la **promoci√≥n 5x4 en Pasad√≠a** (paga 4, el 5.¬∫ entra gratis) cuando aplica seg√∫n la tarifa del d√≠a; se calcula al momento de cotizar su fecha espec√≠fica. ü••\n\nPara orientarle mejor con las promociones y tarifas de esta temporada, d√≠game por favor:  \n- ¬øLe interesa m√°s **pasar solo el d√≠a (Pasad√≠a)** o **hospedaje con noche incluida**?  \n- ¬øPara qu√© **fecha aproximada** y para cu√°ntas personas (adultos y ni√±os de 6 a 10 a√±os) ser√≠a?\n\nCon eso le explico las promociones exactas que aplican para su caso y, si gusta, le armamos la cotizaci√≥n completa ‚òÄÔ∏è'
Nov 21 16:04:57 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Attempt 1/3 to send WATI message to 50375504735
Nov 21 16:04:58 membership start_watibot4.sh[985938]: INFO:httpx:HTTP Request: POST https://live-mt-server.wati.io/1087/api/v1/sendSessionMessage/50375504735 "HTTP/1.1 200 OK"
Nov 21 16:04:58 membership start_watibot4.sh[985938]: INFO:root:[DEBUG] WATI API response: 200 {"ok":true,"result":"success","message":{"whatsappMessageId":"wamid.HBgLNTAzNzU1MDQ3MzUVAgARGBI3QUQyQkQ1OTAyRjJFRUY1QzcA","localMessageId":"2005c686-5044-4d18-904b-eccdf4a846c8","text":"Claro que s√≠ üå¥\n\nEn esta temporada contamos con:\n\n1) **Paquete Pasad√≠a (Day Pass)**  \nIdeal para venir solo por el d√≠a, sin hospedaje. Incluye por persona:  \n- 1 almuerzo üçΩÔ∏è  \n- 3 bebidas (agua, caf√©, soda, refrescos naturales o cervezas nacionales) ü•§  \n- 1 postre üç∞  \n- Uso de todas las √°reas comunes de 7:00 a.m. a 9:00 p.m.  \n- Acceso a piscinas, playa privada y vestidores  \n\n2) **Paquete Las Hojas (con alojamiento)**  \nPensado para disfrutar una estad√≠a completa:  \n- Alojamiento en habitaci√≥n o bungalow  \n- Cena, desayuno y almuerzo por noche  \n- 6 bebidas por persona por noche (agua, caf√©, soda, refrescos naturales o cervezas nacionales)  \n- 2 postres por persona por noche  \n- Uso completo de todas las instalaciones  \n\n3) **Paquete Rom√°ntico (para parejas)** üíï  \nIncluye **todo lo del Paquete Las Hojas** (cena, desayuno, almuerzo, 6 bebidas y 2 postres por persona por noche)  \n+ decoraci√≥n y ambientaci√≥n rom√°ntica especial en la habitaci√≥n.\n\nAdem√°s, tenemos activa la **promoci√≥n 5x4 en Pasad√≠a** (paga 4, el 5.¬∫ entra gratis) cuando aplica seg√∫n la tarifa del d√≠a; se calcula al momento de cotizar su fecha espec√≠fica. ü••\n\nPara orientarle mejor con las promociones y tarifas de esta temporada, d√≠game por favor:  \n- ¬øLe interesa m√°s **pasar solo el d√≠a (Pasad√≠a)** o **hospedaje con noche incluida**?  \n- ¬øPara qu√© **fecha aproximada** y para cu√°ntas personas (adultos y ni√±os de 6 a 10 a√±os) ser√≠a?\n\nCon eso le explico las promociones exactas que aplican para su caso y, si gusta, le armamos la cotizaci√≥n completa ‚òÄÔ∏è","media":null,"messageContact":null,"location":null,"type":"text","time":"1763741098","status":1,"statusString":"SENT","isOwner":true,"botType":null,"isUnread":false,"ticketId":"69208d59014ecc19379e46a4","avatarUrl":null,"assignedId":"605080c2ac6a43ee20c4d7ab","operatorName":null,"replyContextId":null,"sourceType":0,"failedDetail":null,"messageReferral":null,"googleAdsReferral":null,"tikTokAdsReferral":null,"messageProducts":null,"orderProducts":null,"orderDetails":null,"paymentStatus":null,"interactiveData":null,"referenceOrderId":null,"isDeleted":false,"replyButtonPayload":null,"reactions":null,"audioTranscriptionStatus":null,"filePath":null,"isDelayed":false,"translationText":null,"translationStatus":0,"translateTo":null,"callDirection":null,"callEvent":null,"callSession":null,"callDuration":0,"callStatus":null,"callStartTime":0,"callEndTime":0,"callAcceptedBy":null,"callRejectedBy":null,"callInitiatedBy":null,"isCallMadeByExternalAgent":false,"callPermissionReply":null,"id":"69208da9105480fcc9adbe9d","tenantId":"1087","created":"2025-11-21T16:04:57.7444015Z","conversationId":"69208d581d945cd24e492c77","channelId":null,"channelType":0,"importTaskId":null}}
Nov 21 16:04:58 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Successfully processed and sent response to 50375504735 after 1 attempts
Nov 21 16:04:58 membership start_watibot4.sh[985938]: INFO:app.main:[BUFFER] Timer cleanup complete for 50375504735, no orphaned messages
Nov 21 16:04:58 membership start_watibot4.sh[985938]: INFO:app.message_buffer:[LOCK] Released processing lock for 50375504735 (worker PID 985938)
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Buenos d√≠as', reply_context='', waId=50374403004, owner=False, operatorName=None
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Tracking message for bot: wa_id=50374403004, message_key=50374403004:a19f5009c9c8 (total active: 1)
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [MISSED_MESSAGES] Cutoff timestamp (PREVIOUS assistant response) for 50378193399: 2025-11-21 15:41:23+00:00
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [FETCH] Getting messages from WATI API...
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [FETCH] Page 1...
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [SUCCESS] Found 14 messages on page 1
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [FETCH] Page 2...
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [INFO] No more messages found on page 2
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [STATS] Total API messages: 14
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [WEBHOOK] Getting webhook-received messages from database...
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [WEBHOOK] No OpenAI thread found for waId: 50378193399
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [STATS] Webhook messages found: 0
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [COMPARISON] Finding customer messages sent to agents (not webhook)
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [ASSISTANT] Getting assistant responses from OpenAI thread...
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [WEBHOOK] Total webhook interactions (received + sent): 0
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [FILTER] Total API messages with text: 10
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [RESULTS] Customer-to-agent messages found: 10
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ------------------------------------------------------------
Nov 21 16:05:05 membership start_watibot4.sh[985940]: üéØ SUCCESS! Found customer messages sent to human agents:
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [1] 2025-11-21 16:02:36
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     Text: "Gracias, en unos momentos responderemos a su pregunta"
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     assignedId: 60507e60ac6a43ee20c4d602
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     operatorName: 'Bot '
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     eventType: message
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     ‚úÖ NOT FOUND IN WEBHOOK - Likely sent to human agent
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [2] 2025-11-21 16:02:33
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     Text: "Tiene im√°genes del bungalow?"
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     assignedId: None
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     operatorName: 'None'
--
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     operatorName: 'Bot '
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     eventType: message
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     ‚úÖ NOT FOUND IN WEBHOOK - Likely sent to human agent
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [10] 2025-11-21 15:37:55
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     Text: "Quisiera informaci√≥n para una estad√≠a para 5 adultos y un beb√©"
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     assignedId: None
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     operatorName: 'None'
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     eventType: message
Nov 21 16:05:05 membership start_watibot4.sh[985940]:     ‚úÖ NOT FOUND IN WEBHOOK - Likely sent to human agent
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [SUMMARY] MESSAGE CLASSIFICATION
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ================================================================================
Nov 21 16:05:05 membership start_watibot4.sh[985940]: Total API messages analyzed: 14
Nov 21 16:05:05 membership start_watibot4.sh[985940]: API messages with text: 10
Nov 21 16:05:05 membership start_watibot4.sh[985940]: Webhook interactions (received + sent): 0
Nov 21 16:05:05 membership start_watibot4.sh[985940]: Customer-to-agent messages: 10
Nov 21 16:05:05 membership start_watibot4.sh[985940]: üéØ NEXT STEPS:
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ‚úÖ Implement injection of these 10 customer-to-agent messages
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ‚úÖ Add corresponding human agent responses for full context
Nov 21 16:05:05 membership start_watibot4.sh[985940]: ‚úÖ Format as system messages in OpenAI threads
Nov 21 16:05:05 membership start_watibot4.sh[985940]: [MISSED_MESSAGES] Found 3 messages in gap for 50378193399
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:     34.87.13.230:0 - "POST /webhook/universal HTTP/1.1" 200 OK
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:RAW REQUEST BODY: b'{"waId":"50374403004","userMessage":"Buenos d\xc3\xadas","passkey":"FuK@tTcKerZ-2o25"}'
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:HEADERS: {'host': 'lashojasresort.club', 'x-datadog-trace-id': '7503567012690799675', 'x-datadog-parent-id': '2906011154728288384', 'x-datadog-sampling-priority': '0', 'x-datadog-tags': '_dd.p.tid=f1a85436a8e9fe42', 'traceparent': '00-f1a85436a8e9fe426822067143c62c3b-285439bf9ee70080-00', 'tracestate': 'dd=s:0;p:285439bf9ee70080', 'content-type': 'application/json; charset=UTF-8', 'x-forwarded-for': '35.240.137.55', 'x-forwarded-host': 'lashojasresort.club', 'x-forwarded-server': 'lashojasresort.club', 'content-length': '80', 'connection': 'Keep-Alive'}
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:QUERY PARAMS: {}
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK_RECEIVED] waId=50374403004, type=unknown, text_preview='Buenos d√≠as'
Nov 21 16:05:05 membership start_watibot4.sh[985940]: WARNING:app.security:[SECURITY] {'event': 'auth_success', 'ip': '35.240.137.55', 'severity': 'INFO', 'reason': 'Valid passkey provided', 'user_agent': 'unknown'}
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:PARSED DATA: {'waId': '50374403004', 'userMessage': 'Buenos d√≠as', 'passkey': 'FuK@tTcKerZ-2o25'}
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[DEBUG] Parsed waId: 50374403004, message: 'Buenos d√≠as', replyContextId: None, caption: None
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Detected text message for buffering.
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET_DEBUG] Marking processed key=50374403004:a19f5009c9c8 (type=text)
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Marked message as processed: 50374403004:a19f5009c9c8
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[WEBHOOK] Message buffered successfully for 50374403004
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.message_buffer:[LOCK] Acquired processing lock for 50374403004 (worker PID 985940)
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:app.main:[TIMER_THREAD] Acquired lock and started timer for 50374403004 at 2025-11-21 16:05:05.631318
Nov 21 16:05:05 membership start_watibot4.sh[985940]: INFO:     35.240.137.55:0 - "POST /webhook HTTP/1.1" 200 OK
Nov 21 16:05:15 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Message already processed by main webhook: 50374403004:a19f5009c9c8
Nov 21 16:05:15 membership start_watibot4.sh[985940]: INFO:app.main:[SAFETY_NET] Removed tracking for message_key: 50374403004:a19f5009c9c8
Nov 21 16:05:44 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Received: type=text, file_path=None, caption='Buenas d√≠as Valeria me gustar√≠a haver la reservacion  sobre la habitaci√≥n para pareja de 2 personas', reply_context='', waId=50374403004, owner=False, operatorName=Jennifer Mendez
Nov 21 16:05:44 membership start_watibot4.sh[985940]: INFO:app.main:[UNIVERSAL_WEBHOOK] Not caching: type=text, has_file_path=False
Nov 21 16:05:44 membership start_watibot4.sh[985940]: INFO:     35.240.144.126:0 - "POST /webhook/universal HTTP/1.1" 200 OK
